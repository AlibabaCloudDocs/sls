# Analyze the logs of BGP-line Anti-DDoS Pro {#concept_hws_53h_1gb .concept}

On the Full Log page of the BGP-line Anti-DDoS Pro console, the Log Analyses and Log Reports pages of Log Service are embedded. After you activate the Full Log service for BGP-line Anti-DDoS Pro, you can process collected logs in real time on the Full Log page. Specifically, you can search and analyze logs in real time, view or edit a dashboard, configure an alarm, and perform other operations.

## Procedure {#section_zdf_5c2_j2b .section}

1.  Log on to the BGP-line Anti-DDoS Pro console.
2.  In the left-side navigation pane, choose **System** \> **Full Log**.
3.  Select the domain for which you want to analyze logs, and confirm that the **Status** switch is enabled.
4.  Click **Full Log**.

    On this page, the Search & Analysis page of Log Service is embedded. The system automatically executes a search statement to view the logs of the target website. For example, `matched_host:"0523.yuanya.aliyun.com"`.

    ![](images/6846_en-US.png "Analyze logs")

5.  Enter a search statement, select a time range, and then click **Search & Analysis**.

    **Note:** Logs of BGP-line Anti-DDoS Pro can be retained for 180 days.

    ![](images/6847_en-US.png "Log query ")


For the logs obtained on the Search & Analysis page, you can perform the following operations:

-   **Customize search and analysis** 

    Log Service provides the syntax used to search and analyze logs for different scenarios. For more information, see[Query syntax](reseller.en-US/User Guide/Index and query/Query/Query syntax.md#).

-   **View log time distribution** 

    The area under the search box displays the time distribution of the logs that meet the requirements of the query time and the search statement. Time distribution is displayed in the form of a histogram with the horizontal and vertical axis. The total number of queried logs is also displayed.

    **Note:** You can slide the histogram to select a smaller time range. Then, the `time selector` automatically updates the selected time range and refresh the result.

    ![](images/6881_en-US.png "Log time distribution")

-   **View raw logs** 

    The Raw Logs tab page displays the details of each log, including the time and content of each log. The log content contains all the fields of a log. You can sort the columns, download the current query results, or click the gear icon to display specific fields.

    You can click the value of a filed contained in the log content. Then, the system will automatically add the corresponding query condition to the original statement. For example, if you click `GET` in `request_method: GET`, the following statement is automatically added to the search box:

    ``` {#codeblock_9cj_jcc_80o}
    The original search statement and request_method:  GET
    ```

    ![](images/6882_en-US.png "Raw logs")

-   **View charts** 

    Log Service supports charts to display analysis results of logs. You can select different chart types on the Graph page. For more information, see [Query syntax](reseller.en-US/User Guide/Index and query/Query/Query syntax.md#).

    ![](images/6885_en-US.png "Chart")

-   **Quick analysis** 

    The quick analysis feature provides one-click query that helps you quickly analyze the distribution of a field over a period of time and reduce the time cost of indexing critical data. For more information, see [Quick analysis](reseller.en-US/User Guide/Index and query/Query/Quick analysis.md#section_lly_xvj_5cb).

    ![](images/6886_en-US.png "Quick analysis")


## Custom search and analysis {#section_ncn_mvt_j2b .section}

A query statement consists of two parts: query syntax \(`Search`\) and analysis syntax \(`Analytics`\), which are separated by `|`.

``` {#codeblock_kfm_a1u_hon}
$Search | $Analytics
```

|Type|Description|
|:---|:----------|
|Query \(`Search`\)|The query conditions can be generated by keywords, fuzzy, numerical values, interval range and combination conditions. If this field is empty or set to `*`, all data is displayed.|
|Analysis \(`Analytics`\)|Calculate and count the query results or all of the log data.|

**Note:** Both `Search` and `Analytics` are optional. If `Search` is set to empty, all the data in the specified period is not filtered and the results are counted directly. If `Analytics` is set to empty, the query results are returned and no statistics are collected.

## Query syntax {#section_jhz_xvr_k2b .section}

The Log Service query syntax supports **Full-text query** and **Field query**. Query box supports line break display, syntax highlighting, and other functions.

-   **Full-text query** 

    No field is required. You can directly enter one or more keywords included in quotation marks \(""\). You can use a space or `and` to separate two keywords.

    Example:

    -   **Multiple keywords query** 

        Search for logs containing `www.aliyun.com` and `error`. For example:

        ``` {#codeblock_ctq_upv_u8x}
        www.aliyun.com error
        ```

        or

        ``` {#codeblock_phc_q8d_hal}
        www.aliyun.com and error
        ```

    -   **Conditional query** 

        Search for logs that contain `www.aliyun.com`, and `error` or `404`. For example:

        ``` {#codeblock_tvx_8og_ls7}
        www.aliyun.com and (error or 404)
        ```

-   **Prefix query** 

    Search for logs that contain `www.aliyun.com`, and keywords starting with `failed_`. For example:

    ``` {#codeblock_7jx_5bt_wny}
    www.aliyun.com and failed_*
    ```

    **Note:** You can only add an asterisk \(`*`\) after a keyword. No asterisk \(`*`\) can be added before a keyword \(for example, `*_error`\).

-   **Field query** 

    Log Service supports more accurate queries based on fields.

    A comparison of numeric type fields can be implemented in the format `field:value` or `field>=value`, using `and`, `or`. It can also be combined with full-text search, also by using the combination of `and` and `or`.

    BGP-line Anti-DDoS Pro website access logs and attack logs can also be queried based on field query.

    Example

    -   **Multiple fields query** 

        Search for logs containing `www.aliyun.com` attacked by CC:

        ``` {#codeblock_c93_8lh_xif}
        matched_host: www.aliyun.com and cc_blocks: 1
        ```

        Search the access logs containing the error 404 of a client `1.2.3.4` on the website `www.aliyun.com`:

        ``` {#codeblock_iqf_7wi_uuc}
        real_client_ip: 1.2.3.4 and matched_host: www.aliyun.com and status: 404
        ```

        **Note:** Fields used in the examples `matched_host`, `cc_blocks`, `real_client_ip`, and `status` are fields of access and attack logs.

    -   **Numeric field query** 

        Search for all slow request logs with a response time of more than 5 seconds:

        ``` {#codeblock_5lu_mlt_3qr}
        request_time_msec > 5000
        ```

        Interval queries are also supported. You can query logs with a response time greater than 5 seconds and less than or equal to 10 seconds:

        ``` {#codeblock_lga_kqz_cdi}
        request_time_msec in (5000 10000]
        ```

        The query can also be performed by the following statement:

        ``` {#codeblock_3lf_gp4_0t8}
        request_time_msec > 5000 and request_time_msec <= 10000
        ```

    -   **Check whether whether a specific log exists** 
        -   Query logs that contain the `ua_browser` field: `ua_browser: *`.
        -   Query logs that do not contain the `ua_browser` field: `not ua_browser: *`

For more information, see [Index and query overview](reseller.en-US/User Guide/Index and query/Overview.md).

## Analysis syntax {#section_dhz_xvr_k2b .section}

You can use the SQL/92 syntax for log data analysis and statistics. For more information about the syntax and functions supported by Log Service, see [Syntax description](reseller.en-US/User Guide/Index and query/Syntax description.md).

**Note:** 

-   The `from table name` statement in the SQL standard syntax can be omitted from the analysis statement, that is, `from log`.
-   Log data returns the first 100 entries by default, and you can modify the return range by [LIMIT syntax](reseller.en-US/User Guide/Index and query/Analysis grammar/LIMIT syntax.md).

## Time-based log query analysis {#section_eyl_kxt_j2b .section}

Each BGP-line Anti-DDoS Pro log has a `time` field, in the format `year-month-day T hour: minute: second + time zone`. For example, `2018-05-31T20:11:58+08:00`, where the time zone is `UTC+8`, that is Beijing time. At the same time, each log has a built-in field: `__time__`, which also indicates the time of this log, so that time-based calculations can be performed in statistics. The format is [Unix timestamp](https://en.wikipedia.org/wiki/Unix_time). The essence is a cumulative number of seconds since the 1970- 1 0:0:0 UTC time. Therefore, in actual use, after calculation, time must be formatted before it can be displayed.

-   **Select and show time** 

    Over a specific period of time, select the latest 10 logs of the website `www.aliyun.com` attacked by CC, show the time, source IP and access client, using the `time` field directly:

    ``` {#codeblock_alw_nfc_bcs}
    matched_host: www.aliyun.com and cc_blocks: 1 
    |  select time, real_client_ip, http_user_agent
        order by time desc
        limit 10
    ```

-   **Calculate time** 

    To query the number of days after the CC attack, use `__time__` to calculate:

    ``` {#codeblock_yma_u4k_htr}
    matched_host: www.aliyun.com  and cc_blocks: 1 
    |  select time, 
              round((to_unixtime(now()) - __time__)/86400, 1) as "days_passed",             real_client_ip, http_user_agent
          order by time desc
          limit 10
    ```

    **Note:** Use `round((to_unixtime(now()) - __time__)/86400, 1)`, first part `to_unixtime`, the time obtained by `now()`, is converted to a Unix timestamp, and subtracted from the built-in time field `__time__` to get the number of seconds that have passed. Finally, divide by `86400`, which is the total number of seconds in a day, and then round it to the decimal with the function `round(data, 1)`. One-digit value indicates that each attack log has passed a few days.

-   **Group statistics based on specific time** 

    If you want to know how a website is being attacked by CC every day for a specific time frame, use the following SQL:

    ``` {#codeblock_ibn_nap_c1c}
    matched_host: www.aliyun.com  and cc_blocks: 1 
    | select date_trunc('day', __time__) as dt, 
             count(1) as PV 
          group by dt 
          order by dt
    ```

    **Note:** This example uses the built-in time field `__time__` to pass the function `date_trunc('day', ..)` to the time alignment. Each log is grouped into the partition of the day it belongs to for the total number of statistics \(count\(1\)\) and sorted by partition time block. The first argument of the function `date_trunc` provides alignment for other units, including `second`, `miniute`, `hour`, `week`, `month`, `year`. For more information about function, see [Date and time functions](reseller.en-US/User Guide/Index and query/Analysis grammar/Date and time functions.md).

-   **Time-based group statistics** 

    For more flexible grouping time rules, for example, to know the trend of a website being attacked by CC every five minutes the math calculations are required. Run the following SQL:

    ``` {#codeblock_xik_j4s_hsg}
    matched_host: www.aliyun.com  and cc_blocks: 1 
    | select from_unixtime(__time__ - __time__% 300) as dt, 
             count(1) as PV 
          group by dt 
          order by dt 
          limit 1000
    ```

    **Note:** Use the built-in time field to calculate `__time__ - __time__% 300` and format it using the function `from_unixtime`. Each log is grouped into a 5 minute \(300 seconds\) partition for the total number of statistics \(count\(1\)\), and sorted by partition time block to obtain the first 1000 logs, which is equivalent to the first 83 hours of data in the selection time.


More time-resolved functions, such as converting a time format, require using `date_parse` and `date_format`. For more information, see [Date and time functions](reseller.en-US/User Guide/Index and query/Analysis grammar/Date and time functions.md).

## Client IP-based query analysis {#section_zr4_t2v_j2b .section}

Logs of BGP-line Anti-DDoS Pro contain a field `real_client_ip`. However, if the user cannot obtain the real IP through the proxy and the IP address in the header is incorrect, you can use the `remote_addr` field to directly connect to the client IP.

-   **Country distribution of attackers** 

    Distribution of source countries of CC attacks on a website:

    ``` {#codeblock_msj_6yv_05p}
    matched_host: www.aliyun.com  and cc_blocks: 1 
    | SELECT ip_to_country(if(real_client_ip='-', remote_addr, real_client_ip)) as country, 
             count(1) as "number of attacks" 
             group by country
    ```

    **Note:** Use the function `if(condition, option1, option2)` to select the field `real_client_ip` or `real_client_ip` \(when `real_client_ip` is `-`\). Pass the obtained IP to the function `ip_to_country` to get the country information corresponding to this IP.

-   **Province distribution of users who access the website** 

    To get more detailed province-based distribution, use the `ip_to_province` function, for example:

    ``` {#codeblock_xzv_7zk_gb7}
    matched_host: www.aliyun.com  and cc_blocks: 1 
    | SELECT ip_to_province(if(real_client_ip='-', remote_addr, real_client_ip)) as province, 
             count(1) as "number of attacks" 
             group by province
    ```

    **Note:** Another IP function `ip_to_province` to get a province of IP. If IP address is outside of China, system still tries to convert to the province \(state\).

-   **Attackers heat distribution** 

    To get an attackers heat map, use the `ip_to_geo` function, for example:

    ``` {#codeblock_ty3_2w0_4ni}
    matched_host: www.aliyun.com  and cc_blocks: 1 
    | SELECT ip_to_geo(if(real_client_ip='-', remote_addr, real_client_ip)) as geo, 
             count(1) as "number of attacks" 
             group by geo
             limit 10000
    ```

    **Note:** Use another IP function `ip_to_geo` to get the latitude and longitude of an IP and get the first 10,000.


More IP-based parsing functions, such as obtaining the IP operator `ip_to_provider`, determining whether the IP is Internet or Intranet `ip_to_domain`, see [IP functions](reseller.en-US/User Guide/Index and query/Analysis grammar/IP functions.md).

