# 下钻分析 {#concept_v5f_zk4_x2b .concept}

日志服务分析图表除了提供最基本的数据可视化能力之外，还提供了向下钻取（drill down）的功能，您可以在添加一个图表到仪表盘的时候，通过改变下钻列表中的各个配置项，从而使得仪表盘中的分析图表具备更强大的功能。

钻取是在数据分析中不可缺少的功能之一，通过改变展现数据维度的层次、变换分析的粒度从而关注数据中更详尽的信息。它包括向上钻取（roll up）和向下钻取（drill down）。上钻是沿着维度的层次向上聚集汇总数据，下钻是在分析时加深维度，对数据进行层层深入的查看。通过逐层下钻，数据更加一目了然，更能充分挖掘数据背后的价值，及时做出更加正确的决策。

日志服务支持对仪表盘中分析图表的下钻分析，设置下钻的维度和层次后，可以在仪表盘中通过鼠标点击数据点跳转到更深维度的分析页面。仪表盘中的分析图表实际上是查询语句的结果，如果为请求状态表格设置下钻分析、并添加到仪表盘，在仪表盘中单击某个请求状态类型，可以查看请求状态为特定类型的日志信息。

## 限制说明 {#section_jks_2l4_x2b .section}

日志服务中，支持下钻分析的图表包括：

-   表格
-   线图
-   柱状图
-   条形图
-   饼图
-   单值图
-   面积图
-   矩形树图

## 前提条件 {#section_xlz_zw3_y2b .section}

1.  已开启并配置索引。
2.  已配置要跳转到的快速查询、仪表盘和自定义链接。
3.  如果选择添加变量，则需要在跳转到的快速查询和仪表盘配置中配置查询语句变量占位符。详情请参考[快速查询](intl.zh-CN/用户指南/查询与分析/查询语法与功能/其他功能.md)和[创建和删除仪表盘](intl.zh-CN/用户指南/可视化分析/仪表盘/创建和删除仪表盘.md)。

## 配置步骤 {#section_cnd_wl3_y2b .section}

1.  登录[日志服务控制台](https://sls.console.aliyun.com)，单击Project名称。
2.  在Logstore列表的**查询分析**列下单击**查询**。
3.  输入您的查询分析语句，设置时间范围，并单击**搜索**。
4.  在**统计图表**页签中选择**图表类型**，并设置**属性配置**。
5.  在**交互行为**页签中设置下钻**事件行为**。

    下钻事件行为指在仪表盘页面中单击分析图表而触发的事件，默认为关闭状态。设置下钻事件后，在仪表盘中单击这张图表中的数据，根据您配置的事件行为，自动跳转到对应页面。您可以选择以下5种配置。

    -   **不开启**：表示不开启下钻功能。
    -   **打开日志库**：表示开启下钻功能，下钻事件为打开日志库。

        单击图表内容时，如果设置了过滤，会自动为跳转到的日志库增加查询语句。暂不支持设置变量。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990347859_zh-CN.png)

        |配置|说明|
        |--|--|
        |**请选择日志库**|需要跳转到的日志库名称。如何创建日志库请参考[操作Logstore](intl.zh-CN/用户指南/准备工作/操作Logstore.md#) 。|
        |**打开新窗口**|开启该选项后，当触发交互行为时将在新窗口打开对日志库。|
        |**时间范围**|设置跳转到的日志库的查询分析时间范围。可以设置为：         -   **预设**：仪表盘页面中单击图表跳转到日志库后，保持快速查询的默认时间范围，即15分钟（相对）。
        -   **继承图表时间**：跳转后，日志库的查询语句对应的时间范围默认为触发事件时仪表盘中设置的图表的时间。
        -   相对时间：跳转后，将跳转后日志库的快速查询时间设置为指定的相对时间。
        -   整点时间：跳转后，将跳转后日志库的快速查询时间设置为指定的整点时间。
 默认为**预设**。

 |
        |**是否继承筛选条件**|如果选择**继承筛选条件**，则会把触发事件仪表盘中添加的筛选条件同步到对应日志库的快速查询中，并以`AND`的方式添加到查询语句之前。|
        |**过滤**|在**过滤**页签中输入**过滤语句**，语句中可以包含**可选参数域**。 如果配置了**过滤**，在仪表盘图表中单击跳转后，会自动为跳转到的日志库的快速查询增加查询语句，查询语句为此处配置的**过滤语句**。

 |

    -   **打开查询页面**：表示开启下钻功能，下钻事件为打开查询页面。

        单击图表内容时，如果设置了变量，会用单击的图表值替换快速查询语句中设置的占位符，基于图表值进行更深层次的查询；如果设置了过滤，会自动为跳转到的快速查询增加查询语句。支持同时设置变量和占位符。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990310243_zh-CN.png)

        |配置|说明|
        |:-|:-|
        |**请选择快速查询**|需要跳转到的快速查询名称。如何配置快速查询请参考[快速查询](intl.zh-CN/用户指南/查询与分析/查询语法与功能/其他功能.md) 。|
        |**打开新窗口**|开启该选项后，当触发交互行为时将在新窗口打开对应快速查询。|
        |**时间范围**|设置跳转到的快速查询的时间范围。可以设置为：         -   **预设**：仪表盘页面中单击图表跳转到快速查询后，保持快速查询的默认时间范围，即15分钟（相对）。
        -   **继承图表时间**：跳转后，查询语句对应的时间范围默认为触发事件时仪表盘中设置的图表的时间。
        -   相对时间：跳转后，将跳转后的快速查询时间设置为指定的相对时间。
        -   整点时间：跳转后，将跳转后的快速查询时间设置为指定的整点时间。
 默认为**预设**。

 |
        |**是否继承筛选条件**|如果选择**继承筛选条件**，则会把触发事件仪表盘中添加的筛选条件同步到快速查询中，并以`AND`的方式添加到查询语句之前。|
        |**过滤**|在**过滤**页签中输入**过滤语句**，语句中可以包含**可选参数域**。 如果配置了**过滤**，在仪表盘图表中单击跳转后，会自动为跳转到的快速查询增加查询语句，查询语句为此处配置的**过滤语句**。

 |
        |**变量**|在**变量**页签中单击**添加变量**，并指定：         -   **替换变量名**：触发下钻分析的变量，单击即可跳转。
        -   **替换值所在列**：以指定列的对应值进行替换。当有多列时，可以设置为当前列和其他列。当前列为设置下钻的列，即**替换值所在列**所在的列；其他列可以是设置下钻分析的图表中其他任意列。
 当跳转到的快速查询中的查询语句变量和本次添加的变量名称一致时，会将快速查询语句中的变量替换为触发下钻事件的图表值，从而灵活改变目标快速查询中的查询语句。

 **说明：** 

        -   如果选择添加变量，则需要事先在跳转到的快速查询中配置查询语句变量占位符。
        -   最多可以添加5个变量。
 |

    -   **打开仪表盘**：表示开启下钻功能，下钻事件为打开仪表盘。

        仪表盘中的图表实际上是查询语句的图表形式的结果。单击上层仪表盘中的图表内容时，如果设置了变量，且预先在跳转到的仪表盘图表查询语句中设置了占位符，会用单击的图表值替换预设的占位符；如果设置了过滤，会为跳转到的仪表盘增加过滤条件，基于图表值进行更深层次的查询。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990310244_zh-CN.png)

        |配置|说明|
        |:-|:-|
        |**请选择仪表盘**|需要跳转到的目标仪表盘名称，如何配置仪表盘请参考[创建和删除仪表盘](intl.zh-CN/用户指南/可视化分析/仪表盘/创建和删除仪表盘.md)。|
        |**打开新窗口**|开启该选项后，当触发交互行为时将在新窗口打开对应仪表盘。|
        |**时间范围**|设置跳转到的仪表盘的时间范围。可以设置为：         -   **预设**：仪表盘页面中单击图表跳转到仪表盘后，跳转到的仪表盘时间范围保持不变，即保留所有图表的预设时间。
        -   **继承图表时间**：跳转后，仪表盘中图表对应的时间范围默认为触发事件时仪表盘中设置的图表的时间。
        -   相对时间：跳转后，将跳转后的仪表盘时间设置为指定的相对时间。
        -   整点时间：跳转后，将跳转后的仪表盘时间设置为指定的整点时间。
 默认为**预设**。

 |
        |**是否继承筛选条件**|如果选择**继承筛选条件**，则会把触发事件仪表盘中添加的筛选条件同步到跳转到的仪表盘中，并以`AND`的方式添加到查询语句之前。|
        |**过滤**|在**过滤**页签中输入**过滤语句**，语句中可以包含**可选参数域**。 如果配置了**过滤**，在仪表盘图表中单击跳转后，会自动为跳转到的仪表盘添加过滤条件，过滤条件为此处配置的**过滤语句**。

 |
        |**变量**|在**变量**页签中单击**添加变量**，并指定：         -   **替换变量名**：触发下钻分析的变量，单击即可跳转。
        -   **替换值所在列**：以指定列的对应值进行替换。当有多列时，可以设置为**默认列**和其他列。**默认列**即当前列，也就是设置下钻分析的列；其他列可以是设置下钻分析的图表中其他任意列。
 当跳转到的仪表盘中的分析图表查询语句变量和本次添加的变量名称一致时，会将分析图表查询语句中的变量替换为触发下钻事件的图表值，从而灵活改变目标仪表盘中分析图表的查询语句。

 **说明：** 

        -   如果选择添加变量，则需要事先在跳转到的仪表盘中配置查询语句变量占位符。
        -   最多可以添加5个变量。
 |

    -   **自定义http链接**：表示开启下钻功能，下钻事件为打开自定义http链接。

        http链接中的路径部分表示访问的目的端文件的层级路径，您可以在定义http链接的路径部分添加可选参数域，单击仪表盘中的图表内容时，会用图表值替换http链接中的参数，跳转到重新定位的http链接中。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990310245_zh-CN.png)

        |配置|说明|
        |:-|:-|
        |**请输入链接地址**|需要跳转到的目标地址。|
        |**可选参数域**|单击可选参数变量，可以将链接地址中的某一部分替换为触发下钻事件的图表值。|

6.  单击**添加到仪表盘**，配置仪表盘，并单击**确定**。

    后续您可以在仪表盘页面中查看该分析图表，单击图表即可查看更深层次的分析结果。


## 示例 {#section_sjb_xlq_y2b .section}

例如，在名为accesslog的Logstore中存放采集到的Nginx访问日志，名为RequestMethod的仪表盘中展示Nginx日志的常见分析场景，名为destination\_drilldown的仪表盘展示PV随时间分布的趋势。您可以为请求方法的分类表格设置下钻分析，并将其添加到RequestMethod仪表盘中，并将下钻事件设置为跳转到destination\_drilldown仪表盘。在RequestMethod仪表盘中单击各个请求方法即可跳转到destination\_drilldown仪表盘查看对应的PV趋势。

流程如下：

1.  **设置跳转到的仪表盘（destination\_drilldown）**。

    1.  根据请求类型筛选日志，并查看PV随时间的变化。

        查询语句：

        ```
        request_method: * | SELECT date_format(date_trunc('minute', __time__), '%H:%i:%s') AS time, COUNT(1) AS PV GROUP BY time ORDER BY time
        ```

    2.  通过折线图表示查询结果，并将折线图保存到仪表盘中。

        保存到仪表盘时，将`*`设置为占位符，并命名为method，如果跳转到这个快速查询的下钻事件变量同样为method，即可用单击的图表值替换`*`，再次执行查询分析。

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990310732_zh-CN.png)

2.  **设置触发下钻分析的图表，并将其添加到仪表盘（RequestMethod）**。

    1.  在查询页面通过SQL语句分析Nginx访问日志中各种请求方法（request\_method）的日志条数，并将结果以表格形式表示。

        ```
        *|SELECT request_method, COUNT(1) AS c GROUP BY request_method ORDER BY c DESC LIMIT 10
        ```

        查询结果：

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990310705_zh-CN.png)

    2.  为`request_method`一列设置下钻分析：

        ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990310708_zh-CN.png)

3.  **在RequestMethod仪表盘中单击GET请求**。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990410714_zh-CN.png)

4.  **成功跳转到destination\_drilldown仪表盘**。

    页面自动跳转到[1](#step_1)中设置的仪表盘，原查询语句中的`*`已替换为单击的图表值`GET`，表示查看GET请求PV随时间的变化。

    ![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/18631/155920990410739_zh-CN.png)


